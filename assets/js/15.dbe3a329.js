(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{434:function(e,a,t){"use strict";t.r(a);var s=t(24),n=Object(s.a)({},(function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"k8s部署-master节点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#k8s部署-master节点"}},[e._v("#")]),e._v(" k8s部署（Master节点）")]),e._v(" "),t("blockquote",[t("p",[e._v("作者平时也得工作和干活~，尽量在有空的时候不断的去更新该博客...")]),e._v(" "),t("p",[e._v("如果有相关问题或反馈，可以加作者微信（微信号：SPE3SRU3STAY）")])]),e._v(" "),t("h3",{attrs:{id:"四项准备工作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四项准备工作"}},[e._v("#")]),e._v(" 四项准备工作：")]),e._v(" "),t("ul",[t("li",[e._v("本机Hostname解析")]),e._v(" "),t("li",[e._v("网络开关设置")]),e._v(" "),t("li",[e._v("关闭Swap分区")]),e._v(" "),t("li",[e._v("Docker Cgroup Driver的修改")])]),e._v(" "),t("h3",{attrs:{id:"本机hostname解析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#本机hostname解析"}},[e._v("#")]),e._v(" 本机Hostname解析")]),e._v(" "),t("p",[e._v("1.变更主机名（假定我们把"),t("code",[e._v("192.168.0.1")]),e._v("这台机器的主机名叫做"),t("code",[e._v("master")]),e._v("，现在修改主机名）")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("hostnamectl set-hostname master\n")])])]),t("p",[e._v("2.更改/etc/hostname")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('echo "master" > /etc/hostname\n')])])]),t("p",[e._v("3.更改/etc/hosts，在localhost后面追加主机名：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("127.0.0.1 localhost.localdomain localhost master\n")])])]),t("h3",{attrs:{id:"进行网络设置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#进行网络设置"}},[e._v("#")]),e._v(" 进行网络设置")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("echo 1 > /proc/sys/net/bridge/bridge-nf-call-iptables\n")])])]),t("h3",{attrs:{id:"关闭swap分区"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#关闭swap分区"}},[e._v("#")]),e._v(" 关闭Swap分区")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("swapoff  -a\nsed -ri 's/.*swap.*/#&/' /etc/fstab\n")])])]),t("h3",{attrs:{id:"修改docker基座的运行模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#修改docker基座的运行模式"}},[e._v("#")]),e._v(" 修改Docker基座的运行模式")]),e._v(" "),t("blockquote",[t("p",[e._v("假定您按照上一篇"),t("code",[e._v("准备工作的文章")]),e._v("中，调用我的远程脚本安装了Docker的基座服务，那么这一步您将什么都不用去做。")])]),e._v(" "),t("h3",{attrs:{id:"生成kubernetes-master节点的初始化配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#生成kubernetes-master节点的初始化配置文件"}},[e._v("#")]),e._v(" 生成Kubernetes Master节点的初始化配置文件")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("kubeadm config print init-defaults > config.yaml\n")])])]),t("h3",{attrs:{id:"修改这个我们生成出来的config-yaml文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#修改这个我们生成出来的config-yaml文件"}},[e._v("#")]),e._v(" 修改这个我们生成出来的config.yaml文件")]),e._v(" "),t("p",[e._v("vim ./config.yaml")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("apiVersion: kubeadm.k8s.io/v1beta3\nbootstrapTokens:\n- groups:\n  - system:bootstrappers:kubeadm:default-node-token\n  token: abcdef.0123456789abcdef\n  ttl: 24h0m0s\n  usages:\n  - signing\n  - authentication\nkind: InitConfiguration\nlocalAPIEndpoint:\n  advertiseAddress: 192.168.0.1              #修改了这里（修改为当前节点的IP地址）\n  bindPort: 6443\nnodeRegistration:\n  criSocket: /var/run/dockershim.sock\n  imagePullPolicy: IfNotPresent\n  name: master                              #修改了这里（修改为上文中我们预先设定好的hostname）\n  taints: null\n---\napiServer:\n  timeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta3\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrollerManager: {}\ndns: {}\netcd:\n  local:\n    dataDir: /var/lib/etcd\nimageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers         #修改了这里（为了国内加速，不然无法直接下载到Google的对应资源）\nkind: ClusterConfiguration\nkubernetesVersion: 1.22.0\nnetworking:\n  dnsDomain: cluster.local\n  serviceSubnet: 10.100.0.0/16                            #修改了这里（我们认为设定的CIDR）\nscheduler: {}\n")])])]),t("h3",{attrs:{id:"开始拉取kubernetes所需的基础运行镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#开始拉取kubernetes所需的基础运行镜像"}},[e._v("#")]),e._v(" 开始拉取Kubernetes所需的基础运行镜像")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("kubeadm config images pull --config=config.yaml\n")])])]),t("p",[e._v("查看镜像是否下载好")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("docker images\n\n\n\n#下载完成之后的镜像应该是这样的（数量和名称要核对清楚）：\n\nREPOSITORY                                                                    TAG       IMAGE ID       CREATED        SIZE\nregistry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver            v1.22.0   838d692cbe28   3 months ago   128MB\nregistry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager   v1.22.0   5344f96781f4   3 months ago   122MB\nregistry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy                v1.22.0   bbad1636b30d   3 months ago   104MB\nregistry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler            v1.22.0   3db3d153007f   3 months ago   52.7MB\nregistry.cn-hangzhou.aliyuncs.com/google_containers/etcd                      3.5.0-0   004811815584   4 months ago   295MB\nregistry.cn-hangzhou.aliyuncs.com/google_containers/coredns                   v1.8.4    8d147537fb7d   5 months ago   47.6MB\nregistry.cn-hangzhou.aliyuncs.com/google_containers/pause                     3.5       ed210e3e4a5b   7 months ago   683kB\n")])])]),t("p",[e._v("如果镜像下载完成，就可以进入第三阶段了！")]),e._v(" "),t("h3",{attrs:{id:"执行安装命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#执行安装命令"}},[e._v("#")]),e._v(" 执行安装命令")]),e._v(" "),t("p",[e._v("到此时开始，才是真正的动手安装")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("kubeadm init --config=config.yaml\n")])])]),t("blockquote",[t("p",[e._v("如果中间出现了安装错误，或者人为搞错了操作，执行如下命令"),t("code",[e._v("可以清空所有kubeadm的操作缓存")]),e._v("，然后进行重装。命令为："),t("code",[e._v("kubeadm reset")])])]),e._v(" "),t("p",[e._v("出现如下提示时，代表安装成功：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials\n[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token\n[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster\n[bootstrap-token] Creating the "cluster-info" ConfigMap in the "kube-public" namespace\n[kubelet-finalize] Updating "/etc/kubernetes/kubelet.conf" to point to a rotatable kubelet client certificate and key\n[addons] Applied essential addon: CoreDNS\n[addons] Applied essential addon: kube-proxy\n\nYour Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nAlternatively, if you are the root user, you can run:\n\n  export KUBECONFIG=/etc/kubernetes/admin.conf\n\nYou should now deploy a pod network to the cluster.\nRun "kubectl apply -f [podnetwork].yaml" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join 192.168.0.1:6443 --token abcdef.0123456789abcdef \\\n\t--discovery-token-ca-cert-hash sha256:75b93879944f5e2055e97fff426a48a6fe5c0eb91de1739886fa5864d0b12bf6\n\n')])])]),t("h3",{attrs:{id:"为kubectl工具添加认证环境变量"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#为kubectl工具添加认证环境变量"}},[e._v("#")]),e._v(" 为Kubectl工具添加认证环境变量")]),e._v(" "),t("p",[e._v("在/etc/profile中最后面追加以下内容")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("export KUBECONFIG=/etc/kubernetes/admin.conf\n\n(注意) 这里就是上文安装成功时，提示我们需要添加的环境变量\n")])])]),t("p",[e._v("添加完成后，重新加载环境变量")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("source /etc/profile\n")])])]),t("p",[e._v("然后测试kubectl命令")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("kubectl get nodes\n\n\n（返回结果）\nNAME     STATUS     ROLES                  AGE     VERSION\nmaster   NotReady   control-plane,master   4m38s   v1.22.3\n")])])]),t("p",[e._v("查看master节点上运行的容器")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("kubectl get pods --all-namespaces\n\n\n（返回结果）\nNAMESPACE     NAME                             READY   STATUS    RESTARTS        AGE\nkube-system   coredns-7d89d9b6b8-6m6mg         0/1     Pending   0               7m1s\nkube-system   coredns-7d89d9b6b8-fjgl7         0/1     Pending   0               7m1s\nkube-system   etcd-master                      1/1     Running   2 (5m14s ago)   7m5s\nkube-system   kube-apiserver-master            1/1     Running   1 (5m15s ago)   7m5s\nkube-system   kube-controller-manager-master   1/1     Running   2 (5m14s ago)   7m7s\nkube-system   kube-proxy-6krm9                 1/1     Running   1 (5m22s ago)   7m1s\nkube-system   kube-scheduler-master            1/1     Running   1 (5m23s ago)   7m5s\n\n")])])]),t("blockquote",[t("p",[e._v("（到此为止，Master节点就已经安装成功了）")])]),e._v(" "),t("p",[t("br"),t("br"),t("br")]),t("hr"),t("br"),t("br"),t("br"),t("p"),e._v(" "),t("h4",{attrs:{id:"帮助作者改进文档"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#帮助作者改进文档"}},[e._v("#")]),e._v(" 帮助作者改进文档")]),e._v(" "),t("p",[e._v("如果您喜欢这篇文档，想让它变得更好，您可以：")]),e._v(" "),t("ul",[t("li",[e._v("推荐这篇文档，让更多的人知道。")]),e._v(" "),t("li",[e._v("给作者反馈和建议："),t("em",[t("em",[t("a",{attrs:{href:"mailto:tianye3223@gmail.com"}},[e._v("tianye3223@gmail.com")])])])])]),e._v(" "),t("p",[t("br"),t("br"),t("br"),t("br"),t("br")])])}),[],!1,null,null,null);a.default=n.exports}}]);